# 設計メモ

## 座標位置の確定

- 絶対位置のCSS表現
- 制約付きの配置
  - CSSで表現するかどうか
    - flex
    - float
- px単位で画面サイズを決定する
  - 横 (48,27) = (1152px, 648px)
  - 縦 (27,48) = (648px, 1152px)
  - canvasの解像度はどうする？
    - 画面サイズをスケールするときに問題が出る
    - 画面の重なり順の問題もある。
- HTML要素をほぼ静的に作るのはよい
- 問題は、CSSをすべて手書きするところにある

- 仮想的なscreenを考える。
  - camera / screen

- visualizerは(8,4) = (192px, 96px)を基準としている

- シルエット用のエリアは(14,25) = (336, 600)
  - 比率はw/h=0.56で、これは9/16=0.5625に近い
  - 264,192

- 高解像度だと扱いづらいので、1000px弱に縮小して作業する。
  - 画像の縮小はPixelmatorでてきとうに
  - サイズと配置はOmniGraffleで調整する

- テープの元データサイズは 3406x2161
- 調整して(22,14) = (528px, 336px)

- シルエット
  - 左右反転させて右に6(12)

- タイトル画面の選択肢
  - 左右に1.5emつけて+3em
  - 5文字なら幅は8文字

- つづきから / CONTINUE
- はじめから / NEW GAME
- ロード / LOAD GAME

- 25x10.7821 / 48 = 5.615677083333333

- start: 720x480の画像を作る(3:2)
- bg: 1152, 648
- bg@2: 2304, 1296

## 背景画像

```
-- 彩度 (saturate)
s = 1 - t
R = |  s+0.2126t    0.7152t    0.0722t  |  r
G = |    0.2126t  s+0.7152t    0.0722t  |  g
B = |    0.2126t    0.7152t  s+0.0722t  |  b
-- t=1のとき、いわゆるグレースケールへの変換
-- s=1のとき、単位行列
```

```
-- 明るさ (brightness)
R = r * s
G = g * s
B = b * s
```

```
a = 0.2126
b = 0.7152
c = 0.0722

| s+at    bt    ct | | R |
|   at  s+bt    ct | | G |
|   at    bt  s+ct | | B |

| s     | | R |     | a b c | | R |
|   s   | | G | + t | a b c | | G |
|     s | | B |     | a b c | | B |
```

## タスク

- [x] autosave => verse select
- [x] ラベル文字列→ラベルインデックスの表を作る
- [x] @verse命令か@scene命令を作る
  - @startとする
- [x] ダイアログ
- [x] クリック可能な要素にマウスカーソルを設定する
- [x] ダイアログのボイス対応
- [=] システムメニューを自動で閉じる
- [x] セーブ・ロード時のポーズ
- [x] セーブ・ロード時の停止
- [x] nextでwaitForDialogを見るか検討する
  - 一番最初で判定するべきでは？
- [x] ロードの実装
- [=] スクリーンのトランジションアニメーション
- [x] 段落のポーズの問題に対応する
  - 行の処理が終わっていた場合
- [x] BGMを決定可能にする。
  - [x] @music命令か@bgm命令を作る
  - [x] 合流点で一意に決定可能か検査する
  - [x] 短期間に音楽が切り替わる場合を考察する
- [x] タイトル画面に「最初から」「続きから」を付与する
- [=] オートセーブ情報から、タイトル画面で流す音楽を決められる
- [x] 戻る画面を決める
- [x] 既読管理
- [=] スタート直後に@startがはいるときに処理落ちする。
- [=] タイトル画面も絵文字をつける？
- [x] タイトル画面のクリックとonunlockを統合する。
- [x] copyrightのチェック
- [=] チュートリアルをBOOT CAMPにする。
- [x] 第一巻→一巻めの
- [x] nextの領域拡大
- [x] セーブ後の挙動の修正。
- [x] @enterの実装
- [x] finishをどうするか検討する
- [x] finish{bool}を作成する
- [x] copyrightの修正。
- [x] trailer -> preview
- [x] シナリオからロギングを触れるようにする
- [x] 1969はdiana 21
- [x] クレジットを作る
  - [x] グラフの開始点を確認する
  - [x] グラフの色を調整する
  - [x] テキストを作成する
  - [x] 自動スクロール
  - [x] vi05を使う
  - [x] 空のオーバーレイで自動スクロールを禁止する
- [x] オート
  - [=] アイコンをどうする。
- [x] スキップ
- [x] 労組モジュール
- [x] 既読スキップ
- [x] タイトルの音楽切り替え
- [x] オート・スキップをスクリーン遷移前に終わらせる
- [x] シナリオの仕様変更
  - [x] @start/@whenの同時指定を禁止する
  - [x] @systemを廃止して@dialogで代替する
- [x] システム設定
  - [x] システム設定リセット
  - [x] セーブデータリセット
  - [=] 既読リセット
- [x] 背景画像の調整
- [x] 軽量エディタ
  - [x] demeter.jsを再利用できるようにする
  - [x] エディタというより、昔のsketch1のように一括表示を行う。
  - [x] パスの切り替え
  - [x] ダイアログのボタン順序が逆。
- [x] シナリオパーサに@debugモードを作る（警告だけする）
- [x] D.preferences = { musicDir: "...", voiceDir: "..." }
- [x] 画面拡大率の上限
- [x] チュートリアルで質問できるようにする
- [=] スタート画面の入力待ち
- [x] スタート画面の時間調整
- [x] エスケープで戻れるようにする
- [x] シルエットの位置微調整
- [x] rosaのシルエットを用意
- [x] シナリオスクリプトをひとまとめで出力
- [x] クレジットの修正
  - [x] アンロック
  - [x] グラフのかたちが変わったので対応
    - css min,maxを使えるか
  - [x] アニメーションの時間調整
  - [x] ライセンス表記
- [x] クレジット画面をいつでも見られるようにする
- [x] 全部awaitする。
- [=] iOSでスクロールが若干フレーム落ちする
- [=] D.ConsoleLogging
- [x] ログがスクロールしない場合を調べる
  - 自前でスクロールする？
  - 隠れてる状態ではスクロールが効かない？
  - awaitの問題だったとみられる
  - 隠れてる状態ではスクロールが効かない問題のほうだった
- [x] クレジットでEnterを受けつける
- [=] ログを減らす
- [x] 画像が戻ってる。
- [x] 現在地の実装
- [x] narratorの画像を調整する。
- [x] 背景をカラーにする
  - [x] CSSフィルタを実験する
- [x] クレジットが終わった瞬間にクリックするとアイコンが表示したままになる
- [x] キャッシュをどうするか考える
  - 特にメモリキャッシュ
  - パスを変える
- [x] テープのラベルのフォントをちょっとちいさくする
- [x] 表示直後の背景の位置
- [=] overscroll-behavior
  - やるとしたら、微妙に高くして、強制スクロールで戻すとか
  - そこまでやる必要はないかも
- [x] 選択肢が出ている画面でロードしても選択肢が消えない
- [x] コナミコマンド
- [x] チュートリアルと予告編以外はクレジットをだす
- [x] 選択肢のあいだメニューを無効にする
- [=] チュートリアルの質問を分ける
- [x] システムメニューからタイトルに戻る
  - [x] 変更を確認する
- [x] エンド直前でデータをロードするとタイトルに戻ってしまう
  - [x] エンド直前でセーブして、再度呼び出してもおきる
  - paragraphIndexSave, paragraphIndexPrevのリセットタイミング
- [x] 効果音を鳴らす
- [x] paragraphIndexSaveがundefinedにならないように注意する
- [=] leaveをリファクタリングする
- [=] 既読率0%でED
- [=] 自動保存はまとめる
- [x] SKIP中は自動保存しない。
- [x] setSaveしたら現在地をundefinedにするべきでは？
  - [x] タイトル画面でundefinedにする
- [x] 既読率計算用にsystem以外の段落数を数えておく
- [x] 予告編のアンロックをトロフィーにする

- [ ] トロフィー
  - クレジット画面で表示する
- [ ] ログレベル設定

- [ ] バージョンアップと既読率について考える
- [ ] 複数タブで開いている場合の検出
- [ ] エラー通報
- [ ] バージョン更新の仕組み
- [ ] データベースの処理を検討する
  - [ ] バージョン管理
  - [ ] エラー処理
  - [=] トランザクション
- [ ] webworker


