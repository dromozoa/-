<!DOCTYPE html>
<html>

<!--
  -- Copyright (C) 2022 Tomoyuki Fujimori <moyu@dromozoa.com>
  --
  -- This file is part of 昭和横濱物語.
  --
  -- 昭和横濱物語 is free software: you can redistribute it and/or modify
  -- it under the terms of the GNU General Public License as published by
  -- the Free Software Foundation, either version 3 of the License, or
  -- (at your option) any later version.
  --
  -- 昭和横濱物語 is distributed in the hope that it will be useful,
  -- but WITHOUT ANY WARRANTY; without even the implied warranty of
  -- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  -- GNU General Public License for more details.
  --
  -- You should have received a copy of the GNU General Public License
  -- along with 昭和横濱物語.  If not, see <http://www.gnu.org/licenses/>.
  -->

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>昭和横濱物語</title>

  <!-- https://fonts.google.com/ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic&family=BIZ+UDPMincho&family=Share+Tech&family=VT323&display=swap" rel="stylesheet">

  <link href="font_face.css" rel="stylesheet">

  <link href="manifest.webmanifest" rel="manifest">
  <link href="favicon.ico" rel="icon" sizes="any">
  <link href="favicon.svg" rel="icon" type="image/svg+xml">
  <link href="apple-touch-icon.png" rel="apple-touch-icon">

  <script>
    // globalThis.demeter = { config: { debug: true } };
  </script>
  <script defer src="demeter.js"></script>
  <script defer src="demeter-jlreq.js"></script>
</head>
<body>
<div id="loader" style="overflow-wrap: break-word"></div>

<template id="template">
<div><ruby>本文<rt>ながいながいルビ</rt></ruby>あいうえおかきくけこさしすせそ<ruby>本文<rt>ながいながいルビ</rt></ruby>たちつてと。<ruby>本文<rt>ながいながいルビ</rt></ruby>なにぬねの。<ruby>ながいながいながいながいながい本文<rt>ながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいながいルビ</rt></ruby>たちつてと。<br><ruby>ながい本文<rt>ルビ</rt></ruby>あいうえおかきくけこさしすせそ<ruby>ながい本文<rt>ルビ</rt></ruby>たちつてと。</div>
</template>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  let start;

  const D = globalThis.demeter;
  await D.boot();

  const loader = document.getElementById("loader");

  /*
  [...document.fonts].forEach(fontFace => {
    loader.append(D.createElement(`
      <span>■</span>
    `));
  });

  start = performance.now();
  await Promise.all([...document.fonts].map((_, index) => {
    loader.children[index].style.color = "#0f0";
    return (async () => {
      const result = await D.loadFontFace(index, 30000);
      if (result.status === "loaded") {
        loader.children[index].style.color = "#00f";
      } else {
        loader.children[index].style.color = "#f00";
      }
    })();
  }));
  console.log("loader", performance.now() - start);
  */

  const result = await D.loadFontFaces(30000);
  loader.append(...D.createElements(`
    <div>status: ${D.escapeHTML(result.status)}</div>
    <div>elapsed: ${result.elapsed}</div>
  `));

  start = performance.now();
  // const p = D.parseParagraph(D.createElement(`<span>${"TaTiTuTeTo".repeat(1)}</span>`), 32, "'Share Tech'");
  const p = D.parseParagraph(document.getElementById("template").content.firstElementChild, 24, "'Showa Yokohama Story', 'Share Tech', 'BIZ UDPMincho'");
  console.log("p", performance.now() - start);
  console.log(p);

  const t = p[0];
  D.composeText(t, t.fontSize * 20);


});
</script>
</body>
</html>
