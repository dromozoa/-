<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>昭和横濱物語</title>

  <!-- https://fonts.google.com/ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&text=%E6%98%AD%E5%92%8C%E6%A8%AA%E6%BF%B1%E7%89%A9%E8%AA%9E&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <link href="demeter.css" rel="stylesheet">
  <link href="demeter-font.css" rel="stylesheet">

  <link href="manifest.webmanifest" rel="manifest">
  <link href="favicon.ico" rel="icon" sizes="any">
  <link href="favicon.svg" rel="icon" type="image/svg+xml">
  <link href="apple-touch-icon.png" rel="apple-touch-icon">

  <!-- https://lil-gui.georgealways.com/#Guide#Installation -->
  <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.17.0/dist/lil-gui.umd.min.js" integrity="sha256-nxA4RilDJhj/0KWgoBtzApRa21VuGjjinTHof84MK/0=" crossorigin="anonymous"></script>

  <!-- https://github.com/tweenjs/tween.js/#installation -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js" integrity="sha256-2xE/Od+yrQ9FR3LZzqk1yNM0880syyumHSG+6fYJF6U=" crossorigin="anonymous"></script>

  <script defer src="demeter.js"></script>
  <script defer src="demeter-jlreq.js"></script>

  <style>
    .title-ja {
      font-family: 'Yuji Syuku', serif;
      font-size: 96px;
      font-kerning: none;
      color: #C63322;
    }

    .title-ja > span {
      display: inline-block;
      filter: url(#filter-ja);
      transform-origin: center center;
      /*
      transform-origin: left center;
      */
      /* 左手座標系 回転は時計回り */
      transform: rotate3d(1, 0, 0, -90deg);
      opacity: 1;
    }

    .title-en {
      font-family: 'Averia Serif Libre', serif;
      font-size: 36px;
      color: #C63322;
      font-kerning: none;
      transform-origin: center center;
      transform: rotate3d(0, 1, 0, -90deg);
      opacity: 0;
    }

    .title-en > span {
      display: inline-block;
      filter: url(#filter-en);
    }
  </style>
</head>
<body style="
  margin: 0;
  background-color: #000;
  color: #FFF;
">

<div>
  <div class="title-ja"><span
    style="letter-spacing: -0.06em">昭</span><span
    style="letter-spacing: -0.02em">和</span><span
    style="letter-spacing: -0.03em">横</span><span
    style="letter-spacing: -0.05em">濱</span><span
    style="letter-spacing: -0.07em">物</span><span
    style="letter-spacing: 0">語</span></div>
  <div class="title-en"><span
    style="letter-spacing:  0px">S</span><span
    style="letter-spacing: -0.0667px">H</span><span
    style="letter-spacing: -0.3333px">O</span><span
    style="letter-spacing: -1.5px">W</span><span
    style="letter-spacing:  0px">A</span><span
    style="letter-spacing:  0px">&nbsp;</span><span
    style="letter-spacing: -0.8px">Y</span><span
    style="letter-spacing: -0.0667px">O</span><span
    style="letter-spacing: -0.8px">K</span><span
    style="letter-spacing: -0.0667px">O</span><span
    style="letter-spacing:  0px">H</span><span
    style="letter-spacing:  0px">A</span><span
    style="letter-spacing:  0px">M</span><span
    style="letter-spacing:  0px">A</span><span
    style="letter-spacing:  0px">&nbsp;</span><span
    style="letter-spacing: -0.1333px">S</span><span
    style="letter-spacing: -0.6px">T</span><span
    style="letter-spacing: -0.0667px">O</span><span
    style="letter-spacing: -0.5667px">R</span><span
    style="letter-spacing:  0px">Y</span></div>
</div>

<div style="position: absolute; top: -9999px; left: -9999px">
  <svg>
    <defs>
      <filter id="filter-ja">
        <feMorphology operator="dilate" radius="1" in="SourceAlpha" result="dilated"/>
        <feFlood flood-color="#FFFEDA" flood-opacity="1" result="filled"/>
        <feComposite operator="in" in="filled" in2="dilated" result="background"/>
        <feMerge>
          <feMergeNode in="background"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <filter id="filter-en">
        <feMorphology operator="dilate" radius="0.5" in="SourceAlpha" result="dilated"/>
        <feFlood flood-color="#FFFEDA" flood-opacity="1" result="filled"/>
        <feComposite operator="in" in="filled" in2="dilated" result="background"/>
        <feMerge>
          <feMergeNode in="background"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
  </svg>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const D = demeter;
  await D.boot();

  const RingBuffer = class {
    constructor(limit) {
      this.index = 0;
      this.limit = limit;
      this.data = [];
    }

    push(value) {
      this.data[this.index] = value;
      ++this.index;
      this.index %= this.limit;
    }

    forEach(fn) {
      let index = 0;
      for (let i = this.index; i < this.data.length; ++i) {
        fn(this.data[i], index++);
      }
      for (let i = 0; i < this.index; ++i) {
        fn(this.data[i], index++);
      }
    }

    min() {
      return this.data.reduce((acc, value) => Math.min(acc, value), Infinity);
    }

    max() {
      return this.data.reduce((acc, value) => Math.max(acc, value), -Infinity);
    }
  }

  const FrameRateModule = class {
    constructor(width, height) {
      const canvas = document.createElement("canvas");
      canvas.width = width * devicePixelRatio;
      canvas.height = height * devicePixelRatio;
      canvas.style.width = D.numberToCss(width);
      canvas.style.height = D.numberToCss(height);
      const context = canvas.getContext("2d");
      context.scale(devicePixelRatio, devicePixelRatio);

      context.fillStyle = "rgba(255, 255, 255, 0.5)";
      context.font = "16px 'Share Tech Mono'";
      context.textBaseline = "top";

      this.canvas = canvas;
      this.canvasWidth = width;
      this.canvasHeight = height;
      this.prevTime = undefined;
      this.frameCount = 0;
      this.frameRates = new RingBuffer(width);
    }

    update() {
      // 1秒ごとにFPSを計算する。
      const now = performance.now();
      if (this.prevTime === undefined) {
        this.prevTime = now;
        return;
      }
      ++this.frameCount;
      const duration = now - this.prevTime;
      if (duration < 1000) {
        return;
      }
      const frameRate = this.frameCount * 1000 / duration;
      this.frameRates.push(frameRate);
      const frameRateMin = this.frameRates.min();
      const frameRateMax = this.frameRates.max();

      const W = this.canvasWidth;
      const H = this.canvasHeight;
      const context = this.canvas.getContext("2d");
      context.clearRect(0, 0, W, H);
      context.fillText(Math.round(frameRate) + "FPS (" + Math.round(frameRateMin) + "-" + Math.round(frameRateMax) + ")", 0, 0);

      this.frameRates.forEach((v, i) => {
        const h = (H - 16) * Math.min(v, 100) / 100;
        context.fillRect(i, H - h, 1, h);
      });

      this.prevTime = now;
      this.frameCount = 0;
    }
  }

  const gui = new lil.GUI();

  const data = {
    startTitleAnimation: () => {
      let chain;
      [
        ...document.querySelector(".title-ja").children,
        document.querySelector(".title-en"),
      ].forEach(node => {
        const tween = new TWEEN.Tween({ opacity: 0, rotation: -90 })
          .to({ opacity: 1, rotation: 0 }, 500)
          .easing(TWEEN.Easing.Bounce.Out)
          .onUpdate(data => {
            node.style.opacity = data.opacity;
            node.style.transform = "rotate3d(1, 0, 0, " + D.numberToCss(data.rotation, "deg") + ")";
          });
        if (chain === undefined) {
          chain = tween.start();
        } else {
          chain.chain(tween);
          chain = tween;
        }
      });
    },

    resetTitleAnimation: () => {
      [
        ...document.querySelector(".title-ja").children,
        document.querySelector(".title-en"),
      ].forEach(node => {
        node.style.opacity = 0;
        node.style.transform = "rotate3d(1, 0, 0, -90deg)";
      });
    },
  };
  gui.add(data, "startTitleAnimation").name("タイトルアニメーションを開始");
  gui.add(data, "resetTitleAnimation").name("タイトルアニメーションを初期化");

  const frameRateModule = new FrameRateModule(240, 120);
  frameRateModule.canvas.style.display = "block";
  frameRateModule.canvas.style.position = "fixed";
  frameRateModule.canvas.style.right = "15px";
  frameRateModule.canvas.style.bottom = "15px";
  document.body.append(frameRateModule.canvas);

  while (true) {
    await D.requestAnimationFrame();

    TWEEN.update();
    frameRateModule.update();
  }
});
</script>

</body>
</html>
