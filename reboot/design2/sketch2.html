<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>昭和横濱物語</title>

  <!-- https://fonts.google.com/ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&display=swap" rel="stylesheet">

  <link href="demeter.css" rel="stylesheet">
  <link href="demeter-font.css" rel="stylesheet">

  <link href="manifest.webmanifest" rel="manifest">
  <link href="favicon.ico" rel="icon" sizes="any">
  <link href="favicon.svg" rel="icon" type="image/svg+xml">
  <link href="apple-touch-icon.png" rel="apple-touch-icon">

  <!-- https://github.com/tweenjs/tween.js/#installation -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js" integrity="sha256-2xE/Od+yrQ9FR3LZzqk1yNM0880syyumHSG+6fYJF6U=" crossorigin="anonymous"></script>

  <script defer src="demeter.js"></script>
  <script defer src="demeter-jlreq.js"></script>

  <!--
    cursorを設定するとAndroid EmulatorのChromeがクリック時にハイライトする？
    この環境では
      @media (pointer: fine)
      @media (hover: none)
    になるので、@media (hover: none)で切り分ける。
  -->
  <style>
    div.choice > svg {
      display: block;
    }

    div.choice > svg {
      fill: rgba(255, 255, 255, 0.25);
      stroke: #fff;
      transition: all 0.5s;
    }

    div.choice:hover > svg {
      stroke: #029D93;
    }

    div.choice:active > svg {
      fill: rgba(2, 157, 147, 0.25);
      stroke: #029D93;
    }

    @media (hover: none) {
      .hover-none {
        display: block;
      }
      .hover-hover {
        display: none;
      }
    }

    @media (hover: hover) {
      .hover-none {
        display: none;
      }
      .hover-hover {
        display: black;
      }
      div.choice > svg {
        cursor: pointer;
      }
    }
  </style>
</head>

<body style="
  margin: 0 0 0 24px;
  background-color: #000;
  color: #FFF;
">

<div>
  <div class="hover-none">hover: none</div>
  <div class="hover-hover">hover: hover</div>
</div>

<div id="source" style="
  font-size: 24px;
  font-family: 'Showa Yokohama Story', 'BIZ UDPGothic', sans-serif;
  line-height: 2;
">
<div>エデンの園</div>
<div>グライダー<ruby>銃<rt>ガン</rt></ruby></div>
</div>

<div id="container" style="
  position: relative;
  font-size: 24px;
  font-family: 'Showa Yokohama Story', 'BIZ UDPGothic', sans-serif;
  line-height: 2;
  user-select: none;
  -webkit-user-select: none;
"></div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const D = globalThis.demeter;
  await D.boot();

  const start = performance.now();
  const result = await D.loadFontFaces(10000);
  console.log("loadFontFaces", performance.now() - start, result);

  const fontSize = 24;
  const font = "'Showa Yokohama Story', 'BIZ UDPGothic', sans-serif";

  const outputNode = document.body.appendChild(document.createElement("div"));
  outputNode.style.font = D.numberToString(fontSize) + " " + font;

  let firstTextNode;

  const sourceNodes = document.querySelector("#source").children;
  const containerNode = document.getElementById("container");

  for (let i = 0; i < sourceNodes.length; ++i) {
    const sourceNode = sourceNodes[i];
    const paragraph = D.parseParagraph(sourceNode, fontSize, font);
    paragraph.forEach(text => {
      const lines = D.composeText(text, fontSize * 20);
      const textNode = D.layoutText(lines, fontSize, fontSize * 2);
      textNode.style.position = "absolute";
      textNode.style.top = "24px";
      textNode.style.left = "48px";

      const choiceFrameNode = D.createChoiceFrame(fontSize * 24, fontSize * 4, fontSize);
      choiceFrameNode.style.display = "block";

      const choiceNode = document.createElement("div");
      choiceNode.className = "choice";
      choiceNode.style.position = "relative";
      choiceNode.append(textNode, choiceFrameNode);
      choiceNode.addEventListener("click", (ev) => {
        console.log("click", sourceNode);
      });

      containerNode.append(choiceNode);
    });
  }
});
</script>

</body>
</html>
